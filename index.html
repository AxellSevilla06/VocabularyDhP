<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulario Financiero | Supabase App</title>
    <!-- Carga de Tailwind CSS para el estilo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente principal Inter */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f9;
        }
        /* Estilos para voltear la tarjeta */
        .flashcard-front {
            transform: rotateY(0deg);
            backface-visibility: hidden;
            transition: transform 0.6s;
        }
        .flashcard-back {
            transform: rotateY(180deg);
            backface-visibility: hidden;
            transition: transform 0.6s;
        }
        .flipped .flashcard-front {
            transform: rotateY(-180deg);
        }
        .flipped .flashcard-back {
            transform: rotateY(0deg);
        }
        /* Estilo para el contenedor de desplazamiento */
        .card-container {
            scroll-snap-type: x mandatory;
            overflow-x: scroll;
            -webkit-overflow-scrolling: touch;
            padding: 0 4px; /* Ajuste para que las tarjetas no toquen los bordes */
        }
        .card-item {
            scroll-snap-align: center;
            flex-shrink: 0;
            width: 90%; /* Ancho de la tarjeta en móvil */
            max-width: 400px; /* Ancho máximo en escritorio */
            margin: 0 10px;
        }
        /* Ocultar scrollbar */
        .card-container::-webkit-scrollbar {
            display: none;
        }
        .card-container {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        /* El cursor de espera ya no es necesario con SpeechSynthesis, pero lo mantenemos limpio */
    </style>
</head>
<body>

    <div class="max-w-4xl mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800">
                <span class="text-blue-500">FinTech</span> Vocab Builder
            </h1>
            <p class="text-lg text-gray-600 mt-2">Generador de Vocabulario de Finanzas, Economía y Contabilidad (Usando Supabase)</p>
        </header>

        <!-- Sección de Entrada (Input) -->
        <div id="input-section" class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <label for="topicInput" class="block text-sm font-medium text-gray-700 mb-2">
                Escribe el tema específico (Ej: "Instrumentos Derivados", "Informes Contables IFRS"):
            </label>
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <input type="text" id="topicInput" placeholder="Ej: Bonos de alto rendimiento..."
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                <button id="generateBtn" onclick="handleGenerate()"
                        class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 disabled:bg-gray-400">
                    Generar 10 Términos
                </button>
            </div>
        </div>

        <!-- Indicador de Carga y Mensajes -->
        <div id="status-message" class="text-center text-lg font-medium py-4 hidden">
            <p id="message-text" class="text-blue-600"></p>
            <div id="loading-spinner" class="mt-2 mx-auto w-6 h-6 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin hidden"></div>
        </div>
        
        <!-- Botones de Acción y Quiz -->
        <div class="text-center mt-6 flex justify-center space-x-4">
            <button id="saveBtn" onclick="saveVocabularySet()"
                    class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition duration-300 disabled:bg-gray-400 hidden">
                Guardar Lista de Estudio
            </button>
            <button id="quizBtn" onclick="startQuiz()"
                    class="bg-purple-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-purple-700 transition duration-300 disabled:bg-gray-400 hidden">
                Iniciar Modo Quiz
            </button>
        </div>


        <!-- Contenedor Principal de Vistas -->
        <div id="main-content-display" class="mt-8">
            
            <!-- Vista de Flashcards -->
            <div id="flashcard-view">
                <div id="flashcard-navigation" class="relative">
                    <!-- Botón ANTERIOR -->
                    <button id="prevBtn" onclick="prevCard()" 
                            class="absolute left-0 top-1/2 -mt-8 ml-2 p-3 bg-blue-500 text-white rounded-full shadow-lg z-10 transition duration-300 hover:bg-blue-600 focus:outline-none disabled:opacity-50 hidden md:flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                
                    <div id="flashcard-display" class="card-container flex overflow-x-auto justify-start p-4 bg-gray-100 rounded-xl shadow-inner hidden">
                        <!-- Las flashcards se insertarán aquí -->
                    </div>

                    <!-- Botón SIGUIENTE -->
                    <button id="nextBtn" onclick="nextCard()" 
                            class="absolute right-0 top-1/2 -mt-8 mr-2 p-3 bg-blue-500 text-white rounded-full shadow-lg z-10 transition duration-300 hover:bg-blue-600 focus:outline-none disabled:opacity-50 hidden md:flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Vista de Quiz -->
            <div id="quiz-view" class="hidden bg-white p-6 rounded-xl shadow-lg border border-purple-200">
                <h2 id="quiz-title" class="text-2xl font-bold text-purple-700 mb-4 border-b pb-2"></h2>
                <div id="quiz-score" class="text-lg text-gray-600 mb-6"></div>
                <div id="quiz-question-container">
                    <!-- La pregunta y las opciones se insertarán aquí -->
                </div>
                <div id="quiz-feedback" class="mt-4 p-3 rounded-lg font-semibold hidden"></div>
                <button id="nextQuizBtn" onclick="nextQuizQuestion()"
                        class="mt-4 w-full bg-blue-500 text-white font-semibold py-3 rounded-lg hover:bg-blue-600 transition duration-300 disabled:bg-gray-400 hidden">
                    Siguiente Pregunta
                </button>
                <button id="endQuizBtn" onclick="endQuiz()"
                        class="mt-4 w-full bg-red-500 text-white font-semibold py-3 rounded-lg hover:bg-red-600 transition duration-300 hidden">
                    Terminar Quiz
                </button>
            </div>
            
        </div>
        
        <!-- Sección de Listas Guardadas (Opcional, para el seguimiento) -->
        <div id="saved-sets-section" class="mt-12">
            <h2 class="text-2xl font-bold text-gray-800 border-b pb-2 mb-4">Mis Listas Guardadas (Supabase)</h2>
            <div id="saved-sets-list" class="space-y-4">
                <p id="loading-saved-sets" class="text-gray-500 italic">Cargando listas guardadas...</p>
                <!-- Las listas guardadas se cargarán aquí -->
            </div>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script type="module">
        // --------------------------------------------------------
        // Configuración de Supabase y Gemini
        // --------------------------------------------------------
        // CLAVES INYECTADAS POR EL USUARIO PARA SU PROYECTO SUPABASE
        const SUPABASE_URL = 'https://hibfbfjlfwobzmmxgumr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhpYmZiZmpsZndvYnptbXhndW1yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NDQ3MzEsImV4cCI6MjA4MDAyMDczMX0.2KBbfu0hhTGq49xtoUuHvScZJ6XiBXAgAZBYjCoFJC0'; 
        
        // *******************************************************************
        //  CLAVE DE GEMINI: Usada solo para generación de texto (Vocabulario)
        // *******************************************************************
        const GEMINI_API_KEY = "AIzaSyDbqo4FdlrFt84nTS9SYnx7maUH27lF4ws"; 
        
        let supabase = null;
        let userId = null; 
        let currentVocabulary = []; 
        let currentCardIndex = 0; 

        // Variables de estado del Quiz
        let isQuizMode = false;
        let quizQuestions = [];
        let currentQuizIndex = 0;
        let score = 0;

        // Exportar funciones para que sean accesibles desde el ámbito global (window)
        window.handleGenerate = handleGenerate;
        window.saveVocabularySet = saveVocabularySet;
        window.viewSet = viewSet;
        window.deleteSet = deleteSet;
        window.flipCard = flipCard;
        window.nextCard = nextCard;
        window.prevCard = prevCard;
        window.startQuiz = startQuiz; 
        window.checkAnswer = checkAnswer; 
        window.endQuiz = endQuiz; 
        window.speakTerm = speakTerm; 
        window.nextQuizQuestion = nextQuizQuestion; 

        // --- Utilidades de Texto a Voz (SpeechSynthesis API Nativa) ---
        
        /** Genera y reproduce el audio de un término en inglés usando la API nativa. */
        function speakTerm(term) {
            if ('speechSynthesis' in window) {
                // Cancelar cualquier síntesis en curso
                window.speechSynthesis.cancel(); 

                const utterance = new SpeechSynthesisUtterance(term);
                // Intenta usar una voz en inglés americano, si está disponible
                utterance.lang = 'en-US'; 
                
                // Opcional: intentar seleccionar una voz específica
                const voices = window.speechSynthesis.getVoices();
                const enVoice = voices.find(voice => voice.lang === 'en-US' || voice.lang === 'en_US');
                if (enVoice) {
                    utterance.voice = enVoice;
                } else {
                    // Si no encuentra voz en-US, usa la predeterminada (que suele ser en-GB o la del sistema)
                }

                window.speechSynthesis.speak(utterance);

            } else {
                console.error("Speech Synthesis no es soportado por este navegador.");
                setStatus(false, "Error: La función de voz no es soportada por tu navegador.");
            }
        }


        // --- Inicialización de Supabase y Generación de ID de Usuario ---
        function initSupabase() {
            try {
                // Inicializar Supabase Client con las claves del usuario
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase inicializado con URL del usuario.");

                // Usamos un ID de usuario anónimo persistente (guardado en el navegador)
                let storedUserId = localStorage.getItem('supabase_user_id');
                if (!storedUserId) {
                    storedUserId = crypto.randomUUID();
                    localStorage.setItem('supabase_user_id', storedUserId);
                }
                userId = storedUserId;
                
                const loadingSetsEl = document.getElementById('loading-saved-sets');
                if (loadingSetsEl) loadingSetsEl.remove();
                
                // Muestra el ID del usuario actual
                const userDisplay = document.createElement('p');
                userDisplay.className = 'text-sm text-gray-500 mt-4 break-words';
                userDisplay.textContent = `Tu ID de Usuario (Supabase): ${userId}`;
                document.getElementById('saved-sets-section').prepend(userDisplay);
                
                loadSavedSets();

            } catch (error) {
                console.error("Error en la inicialización de Supabase:", error);
                document.getElementById('message-text').textContent = `Error al iniciar Supabase. Revisa la URL y la clave.`;
            }
        }

        // --- Funciones de Utilidad y UI ---

        /** Muestra/oculta mensajes de estado y el spinner de carga. */
        function setStatus(isLoading, message = '') {
            const statusDiv = document.getElementById('status-message');
            const messageText = document.getElementById('message-text');
            const spinner = document.getElementById('loading-spinner');
            const generateBtn = document.getElementById('generateBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (isLoading) {
                statusDiv.classList.remove('hidden');
                messageText.textContent = message;
                spinner.classList.remove('hidden');
                generateBtn.disabled = true;
                if (prevBtn) prevBtn.classList.add('hidden');
                if (nextBtn) nextBtn.classList.add('hidden');
            } else {
                spinner.classList.add('hidden');
                generateBtn.disabled = false;
                if (!message) {
                    statusDiv.classList.add('hidden');
                } else {
                    statusDiv.classList.remove('hidden');
                    messageText.textContent = message;
                }
            }
        }

        /** Actualiza la visibilidad de los botones Anterior/Siguiente (Solo en modo Flashcard) */
        function updateNavButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (currentVocabulary.length <= 1) {
                prevBtn.classList.add('hidden');
                nextBtn.classList.add('hidden');
                return;
            }

            prevBtn.classList.remove('hidden');
            nextBtn.classList.remove('hidden');
            prevBtn.disabled = currentCardIndex === 0;
            nextBtn.disabled = currentCardIndex === currentVocabulary.length - 1;
        }

        /** Alterna entre la vista de Flashcard y la vista de Quiz */
        function toggleView(showQuiz) {
            isQuizMode = showQuiz;
            document.getElementById('flashcard-view').classList.toggle('hidden', showQuiz);
            document.getElementById('quiz-view').classList.toggle('hidden', !showQuiz);
            document.getElementById('saveBtn').classList.toggle('hidden', showQuiz || currentVocabulary.length === 0);
            document.getElementById('quizBtn').classList.toggle('hidden', showQuiz || currentVocabulary.length === 0);
        }

        /** Alterna el volteo de una tarjeta. */
        function flipCard(index) {
            const cardEl = document.getElementById(`card-${index}`);
            if (cardEl) {
                cardEl.classList.toggle('flipped');
            }
        }

        /** Muestra la tarjeta en el índice especificado, desplazando el contenedor. */
        function showCard(index) {
            currentCardIndex = index;
            const container = document.getElementById('flashcard-display');
            const card = document.getElementById(`card-${index}`);
            
            if (card) {
                const containerWidth = container.offsetWidth;
                const cardOffset = card.offsetLeft;
                const scrollPosition = cardOffset - (containerWidth / 2) + (card.offsetWidth / 2);
                
                container.scrollTo({
                    left: scrollPosition,
                    behavior: 'smooth'
                });
            }
            updateNavButtons();
        }

        /** Navega a la tarjeta anterior. */
        function prevCard() {
            if (currentCardIndex > 0) {
                showCard(currentCardIndex - 1);
            }
        }

        /** Navega a la tarjeta siguiente. */
        function nextCard() {
            if (currentCardIndex < currentVocabulary.length - 1) {
                showCard(currentCardIndex + 1);
            }
        }

        /** Renderiza la lista de tarjetas de vocabulario. */
        function renderFlashcards(vocabList) {
            toggleView(false); // Asegura que estemos en la vista de Flashcard
            const display = document.getElementById('flashcard-display');
            display.innerHTML = '';
            
            if (vocabList && vocabList.length > 0) {
                display.classList.remove('hidden');
                document.getElementById('saveBtn').classList.remove('hidden');
                document.getElementById('quizBtn').classList.remove('hidden');
                currentVocabulary = vocabList;

                vocabList.forEach((item, index) => {
                    const cardHtml = `
                        <div id="card-${index}" class="card-item bg-white rounded-xl shadow-xl transition-all duration-300 transform hover:scale-[1.02] cursor-pointer" onclick="flipCard(${index})">
                            <div class="relative w-full h-96">
                                
                                <!-- Cara Frontal (Término) -->
                                <div class="flashcard-front absolute inset-0 p-6 flex flex-col items-center justify-center text-center border-4 border-blue-400 rounded-xl">
                                    <h3 class="text-sm font-bold text-gray-500 mb-2">Término ${index + 1} / ${vocabList.length}</h3>
                                    <div class="flex items-center space-x-2">
                                        <p class="text-4xl font-extrabold text-blue-800">${item.term}</p>
                                        <!-- Botón TTS -->
                                        <button onclick="event.stopPropagation(); speakTerm('${item.term.replace(/'/g, "\\'")}')"
                                                class="text-blue-500 hover:text-blue-700 p-2 rounded-full transition duration-150 focus:outline-none">
                                            <!-- Icono de altavoz (lucide-react icon: Volume2) -->
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2">
                                                <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
                                                <path d="M15.54 8.46a5 5 0 0 1 0 7.07"/>
                                                <path d="M19.07 4.93a10 10 0 0 1 0 14.14"/>
                                            </svg>
                                        </button>
                                    </div>
                                    <p class="mt-4 text-gray-400 italic text-sm">Toca para ver la definición</p>
                                </div>
                                
                                <!-- Cara Trasera (Definición y Ejemplo) -->
                                <div class="flashcard-back absolute inset-0 p-6 flex flex-col justify-start text-left border-4 border-blue-600 bg-blue-50 rounded-xl">
                                    <h3 class="text-xl font-bold text-blue-800 border-b pb-2 mb-3">${item.term}</h3>
                                    <div class="space-y-4">
                                        <div>
                                            <p class="text-sm font-semibold text-gray-700">Concepto (ES):</p>
                                            <p class="text-base text-gray-900">${item.spanishConcept || 'N/A'}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm font-semibold text-gray-700">Definición (EN):</p>
                                            <p class="text-base text-gray-900">${item.definition}</p>
                                        </div>
                                        <div>
                                            <p class="text-sm font-semibold text-gray-700">Ejemplo (EN):</p>
                                            <p class="text-base italic text-gray-600">"${item.example}"</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    display.insertAdjacentHTML('beforeend', cardHtml);
                });

                showCard(0);
                
            } else {
                display.classList.add('hidden');
                document.getElementById('saveBtn').classList.add('hidden');
                document.getElementById('quizBtn').classList.add('hidden');
                currentVocabulary = [];
                updateNavButtons();
            }
        }
        
        // --- Lógica del Generador de Vocabulario (API de Gemini) ---

        /** Maneja el clic del botón de generar. */
        async function handleGenerate() {
            const topic = document.getElementById('topicInput').value.trim();
            if (!topic) {
                setStatus(false, "Por favor, introduce un tema para generar vocabulario.");
                return;
            }

            setStatus(true, `Generando vocabulario sobre "${topic}"...`);
            
            try {
                const systemPrompt = "You are an expert financial and economic vocabulary generator. Your task is to generate exactly 10 advanced English terms related to the user's specified topic. For each term, provide a concise English definition, one comprehensive English example sentence, AND a concise Spanish concept/translation for the term. The output must be a JSON array.";
                const userQuery = `Generate 10 English financial, economic, or accounting terms for the topic: "${topic}".`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            description: "An array of English financial vocabulary terms.",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    term: { type: "STRING", description: "The English financial term." },
                                    definition: { type: "STRING", description: "A concise English definition." },
                                    example: { type: "STRING", description: "A professional English example sentence." },
                                    spanishConcept: { type: "STRING", description: "The concise Spanish concept/translation for the term." }
                                },
                                required: ["term", "definition", "example", "spanishConcept"]
                            }
                        }
                    }
                };

                const apiKey = GEMINI_API_KEY; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                let response = null;
                for (let i = 0; i < 3; i++) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) break; 
                    } catch (e) {
                        console.warn(`Intento ${i + 1} fallido. Reintentando en ${Math.pow(2, i)} segundos...`);
                        if (i < 2) await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                        else throw new Error("Fallo en la conexión después de varios reintentos.");
                    }
                }
                
                if (!response.ok) {
                    throw new Error(`Error de la API: ${response.statusText}`);
                }

                const result = await response.json();
                
                const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!jsonText) {
                    throw new Error("Respuesta inválida de la API.");
                }

                const vocabList = JSON.parse(jsonText);
                
                renderFlashcards(vocabList);
                setStatus(false, `¡Vocabulario de "${topic}" generado con éxito! (${vocabList.length} términos)`);

            } catch (error) {
                console.error("Error al generar vocabulario:", error);
                setStatus(false, `Error: No se pudo generar el vocabulario. ${error.message}. Verifica que la clave de Gemini sea válida.`);
                renderFlashcards([]);
            }
        }
        
        // --- Funciones de Supabase (Guardar y Cargar) ---
        
        /** Guarda el set de vocabulario actual en Supabase. */
        async function saveVocabularySet() {
            if (!userId || currentVocabulary.length === 0) {
                setStatus(false, "Error: No hay vocabulario para guardar o el usuario no está identificado.");
                return;
            }

            const topic = document.getElementById('topicInput').value.trim() || 'Lista sin título';
            setStatus(true, "Guardando lista de estudio en Supabase...");
            document.getElementById('saveBtn').disabled = true;

            try {
                // NOTA: Se asume que la tabla 'finance_vocab_sets' ya existe y tiene RLS configurado
                const { error } = await supabase
                    .from('finance_vocab_sets')
                    .insert([
                        {
                            user_id: userId,
                            topic: topic,
                            count: currentVocabulary.length,
                            vocabulary: currentVocabulary
                        }
                    ]);

                if (error) throw error;

                setStatus(false, `¡Lista "${topic}" guardada con éxito!`);
                
            } catch (error) {
                console.error("Error al guardar en Supabase:", error);
                // MEJORA DE ERROR: Muestra el mensaje exacto de Supabase.
                setStatus(false, `Error al guardar: ${error.message}. Revisa la tabla 'finance_vocab_sets' y las políticas RLS en Supabase.`);
            } finally {
                document.getElementById('saveBtn').disabled = false;
            }
        }

        /** Carga todas las listas guardadas del usuario. */
        async function loadSavedSets() {
            if (!userId) return;

            const listEl = document.getElementById('saved-sets-list');
            listEl.innerHTML = '<p class="text-gray-500 italic">Cargando listas guardadas...</p>';

            try {
                // Usamos un filtro simple por user_id, ordenando por fecha de creación descendente
                const { data, error } = await supabase
                    .from('finance_vocab_sets')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                
                listEl.innerHTML = '';
                if (data.length === 0) {
                    listEl.innerHTML = '<p class="text-gray-500 italic">Aún no has guardado ninguna lista de vocabulario.</p>';
                    return;
                }

                data.forEach(set => {
                    const date = new Date(set.created_at).toLocaleDateString();
                    const itemHtml = `
                        <div class="flex justify-between items-center bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                            <div>
                                <p class="text-lg font-semibold text-gray-800">${set.topic || 'Sin título'}</p>
                                <p class="text-sm text-gray-500">${set.count} términos | Guardado el ${date}</p>
                            </div>
                            <div class="flex space-x-3">
                                <button onclick="viewSet('${set.id}')"
                                        class="text-blue-600 hover:text-blue-800 font-medium">
                                    Ver
                                </button>
                                <button onclick="deleteSet('${set.id}', '${set.topic}')"
                                        class="text-red-600 hover:text-red-800 font-medium">
                                    Eliminar
                                </button>
                            </div>
                        </div>
                    `;
                    listEl.insertAdjacentHTML('beforeend', itemHtml);
                });

            } catch (error) {
                console.error("Error al cargar en Supabase:", error);
                // MEJORA DE ERROR: Muestra el mensaje exacto de Supabase.
                listEl.innerHTML = `<p class="text-red-500 font-medium">Error al cargar listas: ${error.message}. Revisa las políticas RLS.</p>`;
            }
        }

        /** Carga un set de vocabulario guardado y lo muestra en las flashcards. */
        async function viewSet(setId) {
            setStatus(true, "Cargando lista guardada...");
            try {
                const { data, error } = await supabase
                    .from('finance_vocab_sets')
                    .select('*')
                    .eq('id', setId)
                    .single();

                if (error) throw error;
                
                document.getElementById('topicInput').value = data.topic;
                renderFlashcards(data.vocabulary);
                setStatus(false, `Lista "${data.topic}" cargada con éxito.`);

            } catch (error) {
                console.error("Error al ver el set:", error);
                setStatus(false, `Error: No se pudo cargar la lista.`);
            }
        }

        /** Elimina un set de vocabulario guardado (usando un modal simple para confirmar). */
        function deleteSet(setId, topic) {
            const confirmDelete = document.createElement('div');
            confirmDelete.className = 'fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50';
            confirmDelete.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-sm">
                    <h3 class="text-lg font-bold mb-4">Confirmar Eliminación</h3>
                    <p class="text-gray-700 mb-6">¿Estás seguro de que deseas eliminar la lista "${topic}"?</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancelDelete" class="py-2 px-4 bg-gray-300 rounded-lg hover:bg-gray-400">Cancelar</button>
                        <button id="confirmDeleteBtn" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700">Eliminar</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmDelete);

            document.getElementById('cancelDelete').onclick = () => confirmDelete.remove();
            document.getElementById('confirmDeleteBtn').onclick = async () => {
                confirmDelete.remove();
                await performDelete(setId, topic);
            };
        }

        async function performDelete(setId, topic) {
            setStatus(true, `Eliminando lista "${topic}"...`);
            try {
                const { error } = await supabase
                    .from('finance_vocab_sets')
                    .delete()
                    .eq('id', setId);

                if (error) throw error;

                setStatus(false, `Lista "${topic}" eliminada con éxito.`);
                loadSavedSets(); // Recargar la lista
            } catch (error) {
                console.error("Error al eliminar en Supabase:", error);
                setStatus(false, `Error al eliminar: ${error.message}`);
            }
        }

        // --- Lógica del Quiz ---

        /** Prepara las preguntas de selección múltiple. */
        function prepareQuizQuestions() {
            quizQuestions = currentVocabulary.map((correctItem, index) => {
                const question = correctItem.spanishConcept;
                const correctAnswer = correctItem.term;
                
                // Generar distractores (3 incorrectos)
                let distractors = currentVocabulary
                    .filter(item => item.term !== correctAnswer)
                    .map(item => item.term);
                
                // Asegurar que haya suficientes distractores (si la lista es corta)
                if (distractors.length < 3) {
                    // Si no hay suficientes, usamos los disponibles (o repetimos si es necesario)
                    while (distractors.length < 3 && currentVocabulary.length > 1) {
                        const randomItem = currentVocabulary[Math.floor(Math.random() * currentVocabulary.length)];
                        if (!distractors.includes(randomItem.term) && randomItem.term !== correctAnswer) {
                            distractors.push(randomItem.term);
                        }
                    }
                    if (distractors.length > 3) distractors = distractors.slice(0, 3);
                    else if (distractors.length < 3) {
                         while(distractors.length < 3) distractors.push("Otro Término");
                    }
                } else {
                    // Seleccionar 3 distractores al azar
                    distractors = distractors.sort(() => 0.5 - Math.random()).slice(0, 3);
                }

                const options = [...distractors, correctAnswer];
                // Mezclar las opciones
                options.sort(() => 0.5 - Math.random());

                return {
                    index: index + 1,
                    question: question,
                    options: options,
                    correctAnswer: correctAnswer
                };
            });
        }


        /** Inicia el modo quiz. */
        function startQuiz() {
            if (currentVocabulary.length === 0) {
                setStatus(false, "No hay vocabulario para iniciar el quiz.");
                return;
            }
            prepareQuizQuestions();
            currentQuizIndex = 0;
            score = 0;
            toggleView(true);
            document.getElementById('quiz-title').textContent = `Quiz: ${document.getElementById('topicInput').value || 'Lista de Estudio'}`;
            document.getElementById('quiz-feedback').classList.add('hidden');
            document.getElementById('nextQuizBtn').classList.add('hidden');
            document.getElementById('endQuizBtn').classList.add('hidden');
            renderQuizQuestion();
        }

        /** Muestra la pregunta actual del quiz. */
        function renderQuizQuestion() {
            const container = document.getElementById('quiz-question-container');
            const feedback = document.getElementById('quiz-feedback');
            const nextBtn = document.getElementById('nextQuizBtn');
            const endBtn = document.getElementById('endQuizBtn');
            
            feedback.classList.add('hidden');
            nextBtn.classList.add('hidden');
            endBtn.classList.add('hidden');

            if (currentQuizIndex >= quizQuestions.length) {
                // Fin del Quiz
                container.innerHTML = `
                    <div class="text-center py-10">
                        <h3 class="text-3xl font-bold text-green-600 mb-4">¡Quiz Terminado!</h3>
                        <p class="text-2xl text-gray-700">Tu Puntuación Final es:</p>
                        <p class="text-5xl font-extrabold text-blue-600 mt-2">${score} / ${quizQuestions.length}</p>
                    </div>
                `;
                endBtn.classList.remove('hidden'); // Botón para volver a flashcards
                document.getElementById('quiz-score').textContent = "";
                return;
            }

            const q = quizQuestions[currentQuizIndex];
            document.getElementById('quiz-score').textContent = `Pregunta ${q.index} de ${quizQuestions.length} | Aciertos: ${score}`;

            const optionsHtml = q.options.map((option, i) => `
                <button data-answer="${option}" onclick="checkAnswer(this, '${q.correctAnswer}')"
                        class="quiz-option w-full text-left p-4 mb-3 border border-gray-300 rounded-lg hover:bg-blue-50 transition duration-150 focus:outline-none bg-white font-medium text-gray-800">
                    ${option}
                </button>
            `).join('');

            container.innerHTML = `
                <div class="mb-4 p-4 bg-gray-100 rounded-lg">
                    <p class="text-xl font-semibold text-gray-800">¿Cuál es el término en inglés para el concepto:</p>
                    <p class="text-2xl font-bold text-purple-600 mt-2">"${q.question}"</p>
                </div>
                <div id="options-container" class="space-y-3">
                    ${optionsHtml}
                </div>
            `;
        }

        /** Comprueba si la respuesta seleccionada es correcta. */
        function checkAnswer(selectedBtn, correctAnswer) {
            const isCorrect = selectedBtn.getAttribute('data-answer') === correctAnswer;
            const feedback = document.getElementById('quiz-feedback');
            const nextBtn = document.getElementById('nextQuizBtn');
            const options = document.querySelectorAll('.quiz-option');

            // Deshabilitar todas las opciones
            options.forEach(btn => {
                btn.disabled = true;
                if (btn.getAttribute('data-answer') === correctAnswer) {
                    btn.classList.add('bg-green-100', 'border-green-600');
                }
            });

            // Resaltar la selección del usuario
            if (isCorrect) {
                score++;
                feedback.textContent = "¡Correcto! ✅";
                feedback.className = 'mt-4 p-3 rounded-lg font-semibold bg-green-100 text-green-800';
                selectedBtn.classList.add('bg-green-500', 'text-white');
            } else {
                feedback.textContent = `Incorrecto. ❌ La respuesta correcta es: ${correctAnswer}.`;
                feedback.className = 'mt-4 p-3 rounded-lg font-semibold bg-red-100 text-red-800';
                selectedBtn.classList.add('bg-red-500', 'text-white');
            }

            feedback.classList.remove('hidden');
            nextBtn.classList.remove('hidden');
            document.getElementById('quiz-score').textContent = `Pregunta ${currentQuizIndex + 1} de ${quizQuestions.length} | Aciertos: ${score}`;
        }

        /** Avanza a la siguiente pregunta del quiz. */
        function nextQuizQuestion() {
            currentQuizIndex++;
            renderQuizQuestion();
        }

        /** Finaliza el quiz y regresa a la vista de flashcards. */
        function endQuiz() {
            toggleView(false);
            // Mostrar la primera tarjeta del set que se estaba estudiando
            showCard(0); 
        }

        // --- Inicio de la Aplicación ---
        window.onload = initSupabase;
    </script>
</body>
</html>
